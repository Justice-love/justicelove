<!DOCTYPE html> <!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--> <!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"><!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"> <title>AJP &#8211; 轶 & 霄</title> <meta name="description" content="我们的小窝"> <meta name="keywords" content="AJP"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:image" content="https://cdn.justice-love.com/image/jpg/bjfj1.jpg"> <meta name="twitter:title" content="AJP"> <meta name="twitter:description" content="AJP，Apache JServ Protocol 学习"> <!-- Open Graph --> <meta property="og:locale" content="zh_CN"> <meta property="og:type" content="article"> <meta property="og:title" content="AJP"> <meta property="og:description" content="AJP，Apache JServ Protocol 学习"> <meta property="og:url" content="//justice-love.com/ajp/"> <meta property="og:site_name" content="轶 & 霄"> <meta property="og:image" content="//justice-love.com/assets/img/logo.png"> <link rel="canonical" href="//justice-love.com/ajp/"> <link href="//justice-love.com/feed.xml" type="application/atom+xml" rel="alternate" title="轶 & 霄 Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="//justice-love.com/assets/css/main.css"> <link rel="stylesheet" href="//justice-love.com/assets/css/share.min.css"> <!-- JS --> <script src="//justice-love.com/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="//justice-love.com/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="//justice-love.com/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="//justice-love.com/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="//justice-love.com/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="//justice-love.com/favicon.png" /> <link rel="shortcut icon" href="//justice-love.com/favicon.ico" /> <!-- video --> <!-- Background Image --> <style type="text/css">body {background-image:url(https://cdn.justice-love.com/image/jpg/bjtp1.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> <style type="text/css">.feature {background-image:url(https://cdn.justice-love.com/image/jpg/bjfj1.jpg);}</style> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?b8fa0aab7976f4bd13b1648e04c7243f"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="//justice-love.com/">Home</a></li> <li> <a href="#">Articles</a> <ul class="dl-submenu"> <li><a href="//justice-love.com/posts/">日志</a></li> <li><a href="//justice-love.com/yan/">妍小言</a></li> <li><a href="//justice-love.com/shu/">舒小书</a></li> <li><a href="//justice-love.com/haoran/">浩然说</a></li> <li><a href="//justice-love.com/life/">生活日记</a></li> </ul> </li> <li><a href="//justice-love.com/tags/" >All Tags</a></li> </ul><!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper-page animated fadeIn"> <div class="content"> <div class="post-title feature "> <h1>AJP</h1> <h4>01 Jul 2019</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~2 minutes </p><!-- /.entry-reading-time --> <a class="btn zoombtn" href="//justice-love.com/posts/"> <i class="fa fa-chevron-left"></i> </a> </div> <div style="font-size: 15px"> <h2 id="协议简述">协议简述</h2> <p>该协议是基于Apache AJP协议的学习整理版本.AJP是面向数据包设计的,使用二进制字节进行数据传输.端与端之间保持长链接,用以避免套接字创建的开销</p> <p>请求不是通过连接多路复用的,即将连接分配给特定请求后,在请求处理周期终止之前,不会将其用于任何其他请求.</p> <p>请求的基本信息比如请求头,请求方法等都以高度精简的形式进行传输(公共字符串被编码为整数)</p> <h2 id="数据包数据类型">数据包数据类型</h2> <p>协议中有四种数据类型: bytes, booleans, integers, string和bytes.</p> <ul> <li>byte: 单个字节</li> <li>boolean:单字节,1=true;0=false</li> <li>Integer:取值范围是0到2^16 (32768),使用两个字节进行存储</li> <li>string:首先将长度编码为两个字节,然后是字符串+终止符号\0(终止符不计长度)</li> <li>bytes:首先将长度编码为两个字节,然后是数据+终止符号\0(终止符不计长度)</li> </ul> <h2 id="包大小">包大小</h2> <p>最大数据包大小为8 * 1024字节(8k).数据包的实际长度在包头中编码.</p> <h2 id="包头">包头</h2> <p>从客户端发往服务端的包头开始于0x1234,从服务端发往客户端的包头开始于0x4142.在前两个字节之后,有一个带有有效数据包长度的整数.</p> <p><strong>包格式（客户端 - &gt;服务端）</strong></p> <table> <thead> <tr> <th style="text-align: left">字节</th> <th>0</th> <th>1</th> <th>2</th> <th>3</th> <th>4 ……第（n + 3）</th> </tr> </thead> <tbody> <tr> <td style="text-align: left">内容</td> <td>0×12</td> <td>0x34</td> <td>长度第一个字节</td> <td>长度第二个字节</td> <td>数据</td> </tr> </tbody> </table> <p><strong>包格式（服务端 - &gt;服务端）</strong></p> <table> <thead> <tr> <th style="text-align: left">字节</th> <th>0</th> <th>1</th> <th>2</th> <th>3</th> <th>4 ……第（n + 3）</th> </tr> </thead> <tbody> <tr> <td style="text-align: left">内容</td> <td>0x41</td> <td>0x42</td> <td>长度第一个字节</td> <td>长度第二个字节</td> <td>数据</td> </tr> </tbody> </table> <p>对于一个正常的数据包的payload,第一个字节用来指示消息类型.</p> <h2 id="数据包类型">数据包类型</h2> <p><strong>请求的数据包</strong></p> <table> <thead> <tr> <th style="text-align: left">Code</th> <th style="text-align: left">Type of Packet</th> <th style="text-align: left">Meaning</th> </tr> </thead> <tbody> <tr> <td style="text-align: left">2</td> <td style="text-align: left">Forward Request</td> <td style="text-align: left">使用接下来的数据处理请求</td> </tr> <tr> <td style="text-align: left">10</td> <td style="text-align: left">CPing</td> <td style="text-align: left">客户端向要求服务端快速响应CPong</td> </tr> </tbody> </table> <p><strong>响应的数据包</strong></p> <table> <thead> <tr> <th style="text-align: left">Code</th> <th style="text-align: left">Type of Packet</th> <th style="text-align: left">Meaning</th> </tr> </thead> <tbody> <tr> <td style="text-align: left">3</td> <td style="text-align: left">Send Body Chunk</td> <td style="text-align: left">发送数据块作为请求的响应</td> </tr> <tr> <td style="text-align: left">4</td> <td style="text-align: left">Send Headers</td> <td style="text-align: left">发送响应头数据</td> </tr> <tr> <td style="text-align: left">5</td> <td style="text-align: left">End Response</td> <td style="text-align: left">标志response的完结</td> </tr> <tr> <td style="text-align: left">6</td> <td style="text-align: left">Get Body Chunk</td> <td style="text-align: left">发起请求获取请求体内容</td> </tr> <tr> <td style="text-align: left">9</td> <td style="text-align: left">CPong Reply</td> <td style="text-align: left">CPing的响应</td> </tr> </tbody> </table> <h2 id="请求包结构">请求包结构</h2> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AJP13_FORWARD_REQUEST :=
    prefix_code      (byte) 0x02 = 	Forward Request
    method           (byte)
    req_uri          (string)
    remote_addr      (string)
    remote_host      (string)
    server_name      (string)
    server_port      (integer)
    is_ssl           (boolean)
    num_headers      (integer)
    request_headers *(req_header_name req_header_value)
    attributes      *(attribut_name attribute_value)
    request_terminator (byte) OxFF
</code></pre></div></div> <p><strong>request_headers具备以下的结构</strong></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>req_header_name := sc_req_header_name(以下会描述sc_req_header_name映射关系)

sc_req_header_name := 0x000A (integer)

req_header_value := (string)
</code></pre></div></div> <p><strong>attributes</strong>具备以下结构</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>attribute_name := attribute_type(如果是请求参数, 后面会跟参数名称,类型为 string)

attribute_value := (string)
</code></pre></div></div> <h2 id="请求方法">请求方法</h2> <p>请求方法,编码为单个字节：</p> <table> <thead> <tr> <th style="text-align: left">Method Name</th> <th style="text-align: left">Code</th> </tr> </thead> <tbody> <tr> <td style="text-align: left">OPTIONS</td> <td style="text-align: left">1</td> </tr> <tr> <td style="text-align: left">GET</td> <td style="text-align: left">2</td> </tr> <tr> <td style="text-align: left">HEAD</td> <td style="text-align: left">3</td> </tr> <tr> <td style="text-align: left">POST</td> <td style="text-align: left">4</td> </tr> <tr> <td style="text-align: left">PUT</td> <td style="text-align: left">5</td> </tr> <tr> <td style="text-align: left">DELETE</td> <td style="text-align: left">6</td> </tr> </tbody> </table> <h2 id="请求头">请求头</h2> <p>对于请求头的结构,首先通过<code class="language-plaintext highlighter-rouge">num_headers</code>编码请求头的数量,接下来是一系列<code class="language-plaintext highlighter-rouge">req_header_name</code>和<code class="language-plaintext highlighter-rouge">req_header_value</code>键值对,其中<code class="language-plaintext highlighter-rouge">req_header_name</code>使用数值类型进行编码,编码列表如下:</p> <table> <thead> <tr> <th style="text-align: left">Name</th> <th style="text-align: left">Code value</th> <th style="text-align: left">Constant name</th> </tr> </thead> <tbody> <tr> <td style="text-align: left">accept</td> <td style="text-align: left">0xA001</td> <td style="text-align: left">SC_REQ_ACCEPT</td> </tr> <tr> <td style="text-align: left">accept-charset</td> <td style="text-align: left">0xA002</td> <td style="text-align: left">SC_REQ_ACCEPT_CHARSET</td> </tr> <tr> <td style="text-align: left">accept-encoding</td> <td style="text-align: left">0xA003</td> <td style="text-align: left">SC_REQ_ACCEPT_ENCODING</td> </tr> <tr> <td style="text-align: left">accept-language</td> <td style="text-align: left">0xA004</td> <td style="text-align: left">SC_REQ_ACCEPT_LANGUAGE</td> </tr> <tr> <td style="text-align: left">authorization</td> <td style="text-align: left">0xA005</td> <td style="text-align: left">SC_REQ_AUTHORIZATION</td> </tr> <tr> <td style="text-align: left">connection</td> <td style="text-align: left">0xA006</td> <td style="text-align: left">SC_REQ_CONNECTION</td> </tr> <tr> <td style="text-align: left">content-type</td> <td style="text-align: left">0xA007</td> <td style="text-align: left">SC_REQ_CONTENT_TYPE</td> </tr> <tr> <td style="text-align: left">content-length</td> <td style="text-align: left">0xA008</td> <td style="text-align: left">SC_REQ_CONTENT_LENGTH</td> </tr> <tr> <td style="text-align: left">cookie</td> <td style="text-align: left">0xA009</td> <td style="text-align: left">SC_REQ_COOKIE</td> </tr> <tr> <td style="text-align: left">cookie2</td> <td style="text-align: left">0xA00A</td> <td style="text-align: left">SC_REQ_COOKIE2</td> </tr> <tr> <td style="text-align: left">host</td> <td style="text-align: left">0xA00B</td> <td style="text-align: left">SC_REQ_HOST</td> </tr> <tr> <td style="text-align: left">pragma</td> <td style="text-align: left">0xA00C</td> <td style="text-align: left">SC_REQ_PRAGMA</td> </tr> <tr> <td style="text-align: left">referer</td> <td style="text-align: left">0xA00D</td> <td style="text-align: left">SC_REQ_REFERER</td> </tr> <tr> <td style="text-align: left">user-agent</td> <td style="text-align: left">0xA00E</td> <td style="text-align: left">SC_REQ_USER_AGENT</td> </tr> </tbody> </table> <h2 id="属性">属性</h2> <p>属性可通过多种方式传递,如请求参数,query string, basic认证信息(user:pwd@localhost/path)等.</p> <p>对于每个属性,都有一个字节代码表示属性的类型,然后是一个字符串来给出它的值.</p> <p>发送一个特殊的终止代码来发信号通知可选属性列表的末尾(0xFF)</p> <table> <thead> <tr> <th style="text-align: left">Information</th> <th style="text-align: left">Code Value</th> <th style="text-align: left">Note</th> </tr> </thead> <tbody> <tr> <td style="text-align: left">remote_user</td> <td style="text-align: left">0x03</td> <td style="text-align: left">请求认证</td> </tr> <tr> <td style="text-align: left">auth_type</td> <td style="text-align: left">0x04</td> <td style="text-align: left">请求认证</td> </tr> <tr> <td style="text-align: left">query_string</td> <td style="text-align: left">0x05</td> <td style="text-align: left"> </td> </tr> <tr> <td style="text-align: left">route</td> <td style="text-align: left">0x06</td> <td style="text-align: left">请求粘性</td> </tr> <tr> <td style="text-align: left">ssl_cert</td> <td style="text-align: left">0x07</td> <td style="text-align: left"> </td> </tr> <tr> <td style="text-align: left">ssl_cipher</td> <td style="text-align: left">0x08</td> <td style="text-align: left"> </td> </tr> <tr> <td style="text-align: left">ssl_session</td> <td style="text-align: left">0x09</td> <td style="text-align: left"> </td> </tr> <tr> <td style="text-align: left">req_attribute</td> <td style="text-align: left">0x0A</td> <td style="text-align: left">请求参数</td> </tr> <tr> <td style="text-align: left">ssl_key_size</td> <td style="text-align: left">0x0B</td> <td style="text-align: left"> </td> </tr> <tr> <td style="text-align: left">secret</td> <td style="text-align: left">0x0C</td> <td style="text-align: left"> </td> </tr> <tr> <td style="text-align: left">stored_method</td> <td style="text-align: left">0x0D</td> <td style="text-align: left"> </td> </tr> <tr> <td style="text-align: left">are_done</td> <td style="text-align: left">0xFF</td> <td style="text-align: left">request_terminator</td> </tr> </tbody> </table> <h2 id="响应包结构">响应包结构</h2> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AJP13_SEND_BODY_CHUNK := 
  prefix_code   3
  chunk_length  (integer)
  chunk         (bytes)


AJP13_SEND_HEADERS :=
  prefix_code       4
  http_status_code  (integer)
  http_status_msg   (string)
  num_headers       (integer)
  response_headers *(res_header_name header_value)

res_header_name := sc_res_header_name (以下会描述sc_req_header_name映射关系)
sc_res_header_name := 0xA0 (byte)
header_value := (string)

AJP13_END_RESPONSE :=
  prefix_code       5
  reuse             (boolean)


AJP13_GET_BODY_CHUNK :=
  prefix_code       6
  requested_length  (integer)
</code></pre></div></div> <h4 id="send-headers">Send Headers</h4> <p>状态代码和消息是通常的请求状态的描述（例如“200”和“OK”). 响应头的编码格式和请求头类似,映射关系如下:</p> <table> <thead> <tr> <th style="text-align: left">Name</th> <th style="text-align: left">Code value</th> </tr> </thead> <tbody> <tr> <td style="text-align: left">Content-Type</td> <td style="text-align: left">0xA001</td> </tr> <tr> <td style="text-align: left">Content-Language</td> <td style="text-align: left">0xA002</td> </tr> <tr> <td style="text-align: left">Content-Length</td> <td style="text-align: left">0xA003</td> </tr> <tr> <td style="text-align: left">Date</td> <td style="text-align: left">0xA004</td> </tr> <tr> <td style="text-align: left">Last-Modified</td> <td style="text-align: left">0xA005</td> </tr> <tr> <td style="text-align: left">Location</td> <td style="text-align: left">0xA006</td> </tr> <tr> <td style="text-align: left">Set-Cookie</td> <td style="text-align: left">0xA007</td> </tr> <tr> <td style="text-align: left">Set-Cookie2</td> <td style="text-align: left">0xA008</td> </tr> <tr> <td style="text-align: left">Servlet-Engine</td> <td style="text-align: left">0xA009</td> </tr> <tr> <td style="text-align: left">Status</td> <td style="text-align: left">0xA00A</td> </tr> <tr> <td style="text-align: left">WWW-Authenticate</td> <td style="text-align: left">0xA00B</td> </tr> </tbody> </table> <h4 id="end-response">End Response</h4> <p>该消息标志着响应的终止,如果reuse=0,标志着连接发生错误,将关闭连接,正常情况reuse=1,标志连接正常,可重用.</p> <h4 id="get-body-chunk">Get Body Chunk</h4> <p>该数据包用于向服务端获取更多的请求体数据,请求体数据使用数据包code为3的<code class="language-plaintext highlighter-rouge">Send Body Chunk</code>类型数据作为响应.</p> </div> <div class="entry-meta"> <br> <hr> <script src="https://apps.bdimg.com/libs/jquery/1.8.2/jquery.js"></script> <script src="//justice-love.com/assets/js/jquery.share.min.js"></script> <span class="entry-tags"><a href="//justice-love.com/tags/#AJP" title="Pages tagged AJP" class="tag"><span class="term">AJP</span></a></span> <div id="share-china"></div> <div style="clear:both"></div> <script> $('#share-china').share({sites: ['qzone', 'weibo','wechat', 'facebook', 'twitter']}); </script> </div> </div> </div> <section id="disqus_thread" class="animated fadeInUp"> <div id="gitalk-container"></div> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script type="text/javascript"> var id = document.URL; if (id.indexOf('?') > 0) { id = id.substr(0, id.indexOf('?')); } const gitalk = new Gitalk({ clientID: '94ea015a2463191dc163', clientSecret: '5fba2b9dc7bf84584dd7a7d8d070e3c0e9d260bf', accessToken: '5facc6f1b9b0e6f0e66e986ba01423102f89d5c7', repo: 'blog-comments', owner: 'Justice-love', admin: ['Justice-love'], distractionFreeMode: false, labels: ['comments'], title: 'AJP', id: id, proxy: 'https://proxy.justice-love.com/https://github.com/login/oauth/access_token' }); gitalk.render('gitalk-container'); </script> </section> </header> <!-- JS --> <script src="//justice-love.com/assets/js/jquery-3.6.0.min.js"></script> <script src="//justice-love.com/assets/js/jquery.dlmenu.min.js"></script> <script src="//justice-love.com/assets/js/jquery.goup.min.js"></script> <script src="//justice-love.com/assets/js/jquery.magnific-popup.min.js"></script> <script src="//justice-love.com/assets/js/jquery.fitvid.min.js"></script> <script src="//justice-love.com/assets/js/scripts.js"></script> <script src="//justice-love.com/assets/js/clipboard.min.js"></script> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
